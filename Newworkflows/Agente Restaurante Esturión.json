{
  "active": false,
  "activeVersion": null,
  "activeVersionId": null,
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Redis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis1": {
      "main": [
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "Redis2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis2": {
      "main": [
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields2": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Edit Fields3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis3": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Redis4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis4": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields3": {
      "main": [
        [
          {
            "node": "Redis3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis5": {
      "main": [
        [
          {
            "node": "Edit Fields4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields4": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "If5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Get many events in Google Calendar": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "If5": {
      "main": [
        [],
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "If6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If6": {
      "main": [
        [
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait2": {
      "main": [
        [
          {
            "node": "HTTP Request2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If7": {
      "main": [
        [
          {
            "node": "Wait3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait3": {
      "main": [
        [
          {
            "node": "HTTP Request3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Redis5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Think": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Disponibilidad Esturion": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Agendar Esturion": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Modificar Evento Esturion": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar Evento Esturion": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request2": {
      "main": [
        [
          {
            "node": "If7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "AI Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Structured Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2026-01-23T15:22:44.676Z",
  "id": "-cgq3cFKFQQwwszD4Iorv",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Agente Restaurante Esturi√≥n",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "cf611be9-ebe6-48f4-af1c-6996d5dfb497",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1280,
        64
      ],
      "id": "09ebca50-aa3f-416a-9a56-347833045084",
      "name": "Webhook",
      "webhookId": "cf611be9-ebe6-48f4-af1c-6996d5dfb497"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "844d9ab8-f2dd-47b5-8f29-29ea70e52009",
              "leftValue": "={{ $json.body.event }}",
              "rightValue": "=message_created",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -1056,
        64
      ],
      "id": "180dc0d6-49a2-4256-9b9f-76c828130a0a",
      "name": "If"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "db7831e6-2930-4c9d-adbd-0b6cb1a0294b",
              "leftValue": "={{ $json.body.conversation.messages[0].sender_type }}",
              "rightValue": "Contact",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -832,
        64
      ],
      "id": "e2369819-4eee-4660-a986-d8de8920fb32",
      "name": "If1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "34908a1a-910b-4240-b270-c5bae76d6672",
              "name": "accountID",
              "value": "={{ $json.body.account.id }}",
              "type": "string"
            },
            {
              "id": "861750b8-6d53-4256-833c-048704fb4711",
              "name": "conversationID",
              "value": "={{ $json.body.conversation.messages[0].conversation_id }}",
              "type": "string"
            },
            {
              "id": "db3956f9-9900-4b56-ac29-ffe7889b2299",
              "name": "sessionID",
              "value": "={{ $json.body.conversation.messages[0].source_id }}",
              "type": "string"
            },
            {
              "id": "cd35006e-6aca-472c-a395-8218acf4de48",
              "name": "Identificador",
              "value": "={{ $json.body.conversation.meta.sender.identifier }}",
              "type": "string"
            },
            {
              "id": "1f42345f-4d66-4ac4-9368-2b08b226d4b0",
              "name": "telefono",
              "value": "={{ $json.body.conversation.meta.sender.phone_number }}",
              "type": "string"
            },
            {
              "id": "55ad0e2a-09a6-42b7-925d-d30a4b19661b",
              "name": "mensaje",
              "value": "={{ $json.body.content }}",
              "type": "string"
            },
            {
              "id": "f1e69443-9dbe-4203-b32c-98bd1dcddbc1",
              "name": "data_time",
              "value": "={{ $json.body.conversation.timestamp.toDateTime('s').toLocal() }}",
              "type": "string"
            },
            {
              "id": "470e66ac-542e-461a-829b-aa96232dec8c",
              "name": "tipo_mensaje",
              "value": "={{ $json.body.conversation.messages[0].attachments[0].file_type }}",
              "type": "string"
            },
            {
              "id": "9dd36975-250a-4e22-a33e-e7068195cd65",
              "name": "body.conversation.messages[0].attachments[0].data_url",
              "value": "={{ $json.body.conversation.messages[0].attachments[0].data_url }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -608,
        64
      ],
      "id": "1e6f1e8c-570f-4012-875a-df45fc8d55b5",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "jsCode": "// Obtener el valor original del campo\nconst sender = $input.first().json.telefono;\n\n// Limpiar el n√∫mero:\n// - Eliminar el prefijo '34' o '49' si existe, y quitar el dominio de whatsapp\nconst cleanedNumber = sender\n  .replace(/^(\\+?34|\\+?49)/, '') // Quita el '+34', '34', '+49' o '49' al inicio\n  .replace(/@s\\.whatsapp\\.net$/, ''); // Quita el '@s.whatsapp.net' al final\n\n// Devolver el n√∫mero limpio\nreturn [\n  {\n    json: {\n      cleanedNumber\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        288,
        160
      ],
      "id": "3b8fd9bf-62a9-452e-a274-c1b32e943f82",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $json.Identificador }}",
        "messageData": "={{ $json.mensaje }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        736,
        160
      ],
      "id": "ad75c0e8-9471-428e-b242-4836bb7b1e35",
      "name": "Redis",
      "credentials": {
        "redis": {
          "id": "rmwGdInGMfi5lhMd",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        960,
        160
      ],
      "id": "995adcfc-6315-43d7-a383-8db6dc454cfa",
      "name": "Wait",
      "webhookId": "71ac37ec-4a28-4234-a581-e5bf42c39a02"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "message",
        "key": "={{ $('Edit Fields1').item.json.Identificador }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1184,
        160
      ],
      "id": "2dd7d577-4ec0-470b-8b80-ccc3cfcb811b",
      "name": "Redis1",
      "credentials": {
        "redis": {
          "id": "rmwGdInGMfi5lhMd",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "96158e05-c548-462c-94c3-8138dd2ceaf9",
              "leftValue": "={{ $json.message.last() }}",
              "rightValue": "={{ $('Edit Fields1').item.json.mensaje }}",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1408,
        160
      ],
      "id": "af6cf21c-3432-4f21-b594-45b5cf2f0118",
      "name": "If3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "34908a1a-910b-4240-b270-c5bae76d6672",
              "name": "accountID",
              "value": "={{ $('Edit Fields').item.json.accountID }}",
              "type": "string"
            },
            {
              "id": "861750b8-6d53-4256-833c-048704fb4711",
              "name": "conversationID",
              "value": "={{ $('Edit Fields').item.json.conversationID }}",
              "type": "string"
            },
            {
              "id": "db3956f9-9900-4b56-ac29-ffe7889b2299",
              "name": "sessionID",
              "value": "={{ $('Edit Fields').item.json.sessionID }}",
              "type": "string"
            },
            {
              "id": "cd35006e-6aca-472c-a395-8218acf4de48",
              "name": "Identificador",
              "value": "={{ $('Edit Fields').item.json.Identificador }}",
              "type": "string"
            },
            {
              "id": "54a552ab-1572-4814-8549-4887c93002c0",
              "name": "telefono",
              "value": "={{ $json.cleanedNumber }}",
              "type": "string"
            },
            {
              "id": "55ad0e2a-09a6-42b7-925d-d30a4b19661b",
              "name": "mensaje",
              "value": "={{ $('Edit Fields').item.json.mensaje }}",
              "type": "string"
            },
            {
              "id": "f1e69443-9dbe-4203-b32c-98bd1dcddbc1",
              "name": "data_time",
              "value": "={{ $('Edit Fields').item.json.data_time }}",
              "type": "string"
            }
          ]
        },
        "options": {
          "ignoreConversionErrors": false
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        512,
        160
      ],
      "id": "afab4f5d-bf6c-4d37-b878-c08723a28cd5",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Edit Fields1').item.json.Identificador }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1632,
        160
      ],
      "id": "bae20086-d8af-4e54-837d-074ed2ba05fc",
      "name": "Redis2",
      "credentials": {
        "redis": {
          "id": "rmwGdInGMfi5lhMd",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5a1e36e3-f8de-419c-83ae-5cc7fead47df",
              "name": "mensaje",
              "value": "={{ $json.message.join(\" \") }}",
              "type": "string"
            },
            {
              "id": "ed4e679f-704c-454a-88e4-d46623e9b6dd",
              "name": "telefono",
              "value": "={{ $('Edit Fields1').item.json.telefono }}",
              "type": "string"
            },
            {
              "id": "67bac86b-a225-4b80-8f56-0544eb594701",
              "name": "Identificador",
              "value": "={{ $('Edit Fields1').item.json.Identificador }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1856,
        160
      ],
      "id": "24a5b624-9aee-4f38-b41d-999932882550",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "url": "=https://n8n2nkz-chatwoot.vc1wee.easypanel.host{{ $json.body.conversation.messages[0].attachments[0].data_url.replace('http://https', '') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -160,
        -32
      ],
      "id": "d5726742-496c-41b9-badb-97f4d7bd5ca9",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "binaryPropertyName": "=data",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        64,
        -32
      ],
      "id": "ccbdf1f0-f637-47a6-9881-5e21aaf7310a",
      "name": "Transcribe a recording",
      "credentials": {
        "openAiApi": {
          "id": "WvSLkCujVhY8jIGz",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Obtener el valor original del campo\nconst sender = $('If4').first().json.telefono;\n// Eliminar el prefijo '34' o '49' si existe, y quitar el dominio de WhatsApp\nconst cleanedNumber = sender\n  .replace(/^(\\+?34|\\+?49)/, '')       // Quita el '+34', '34', '+49' o '49' al inicio\n  .replace(/@s\\.whatsapp\\.net$/, ''); // Quita el '@s.whatsapp.net' al final\n\n// Devolver el n√∫mero limpio\nreturn [\n  {\n    json: {\n      cleanedNumber\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        288,
        -32
      ],
      "id": "c58371cf-ea37-49f2-aae7-3453150feae5",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $json.Identificador }}",
        "messageData": "={{ $json.mensaje_audio }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        736,
        -32
      ],
      "id": "309fefb2-cfb5-4b7e-8e66-38851fc379cf",
      "name": "Redis3",
      "credentials": {
        "redis": {
          "id": "rmwGdInGMfi5lhMd",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        960,
        -32
      ],
      "id": "e013c1e7-d539-40e0-95e1-175614b2f19d",
      "name": "Wait1",
      "webhookId": "71ac37ec-4a28-4234-a581-e5bf42c39a02"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "message",
        "key": "={{ $('Edit Fields3').item.json.Identificador }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1184,
        -32
      ],
      "id": "66d7ab14-3c91-4641-90d7-07b3234c0df6",
      "name": "Redis4",
      "credentials": {
        "redis": {
          "id": "rmwGdInGMfi5lhMd",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "34908a1a-910b-4240-b270-c5bae76d6672",
              "name": "accountID",
              "value": "={{ $('Edit Fields').item.json.accountID }}",
              "type": "string"
            },
            {
              "id": "861750b8-6d53-4256-833c-048704fb4711",
              "name": "conversationID",
              "value": "={{ $('Edit Fields').item.json.conversationID }}",
              "type": "string"
            },
            {
              "id": "db3956f9-9900-4b56-ac29-ffe7889b2299",
              "name": "sessionID",
              "value": "={{ $('Edit Fields').item.json.sessionID }}",
              "type": "string"
            },
            {
              "id": "cd35006e-6aca-472c-a395-8218acf4de48",
              "name": "Identificador",
              "value": "={{ $('Edit Fields').item.json.Identificador }}",
              "type": "string"
            },
            {
              "id": "54a552ab-1572-4814-8549-4887c93002c0",
              "name": "telefono",
              "value": "={{ $json.cleanedNumber }}",
              "type": "string"
            },
            {
              "id": "55ad0e2a-09a6-42b7-925d-d30a4b19661b",
              "name": "mensaje_audio",
              "value": "={{ $('Transcribe a recording').item.json.text }}",
              "type": "string"
            },
            {
              "id": "f1e69443-9dbe-4203-b32c-98bd1dcddbc1",
              "name": "data_time",
              "value": "={{ $('Edit Fields').item.json.data_time }}",
              "type": "string"
            }
          ]
        },
        "options": {
          "ignoreConversionErrors": false
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        512,
        -32
      ],
      "id": "80dcc6c6-526f-4f68-8aea-c1a2288c3271",
      "name": "Edit Fields3"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Edit Fields3').item.json.Identificador }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1632,
        -32
      ],
      "id": "e6a77126-682c-4461-9bc3-92bdd60337d0",
      "name": "Redis5",
      "credentials": {
        "redis": {
          "id": "rmwGdInGMfi5lhMd",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5a1e36e3-f8de-419c-83ae-5cc7fead47df",
              "name": "mensaje_audio",
              "value": "={{ $json.message.join(\" \") }}",
              "type": "string"
            },
            {
              "id": "ed4e679f-704c-454a-88e4-d46623e9b6dd",
              "name": "telefono",
              "value": "={{ $('Edit Fields3').item.json.telefono }}",
              "type": "string"
            },
            {
              "id": "67bac86b-a225-4b80-8f56-0544eb594701",
              "name": "Identificador",
              "value": "={{ $('Edit Fields3').item.json.Identificador }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1856,
        -32
      ],
      "id": "f6791cfd-531b-4697-b203-06dbc808cdf7",
      "name": "Edit Fields4"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensaje_texto_cliente: {{ $json.mensaje }}\nMensaje_audio_cliente: {{ $json.mensaje_audio }}\nTelefono cliente: {{ $json.telefono }}\n",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=# Identidad\nEres Beatriz, recepcionista virtual del Restaurante Esturi√≥n. Hablas de forma natural y humana, tratas de usted, usas emoticonos ocasionalmente (var√≠alos), y eres concisa. Usas \"reservar\" o \"hacer la reserva\".\n\n## Presentaci√≥n inicial\n**Solo en el primer mensaje** (cuando detectes un saludo sin contexto: \"Hola\", \"Buenos d√≠as\", etc.):\n\"Hola, soy Beatriz, la asistente virtual del Restaurante Esturi√≥n üòä\"\n\nLuego pregunta en qu√© puedes ayudar. **Nunca vuelvas a presentarte** en esa conversaci√≥n.\n\n---\n\n# √Åmbito de actuaci√≥n\n\n## Mensajes que atiendes:\n- Saludos y despedidas\n- Analiza el mensaje que te puede llegar tanto en formato de texto {{ $json.mensaje }} o formato de audio  {{ $json.mensaje_audio }} y responde en consecuencia.\n- Consultas sobre el restaurante (ubicaci√≥n, horarios, carta, precios, parking, accesibilidad, ambiente, terraza)\n- Gesti√≥n de reservas (crear, modificar, cancelar, consultar disponibilidad)\n- Informaci√≥n sobre eventos, bodas, m√∫sica en directo, animaci√≥n infantil\n- Preguntas gastron√≥micas (platos destacados, tipo de cocina, vinos)\n\n## Mensajes fuera de contexto:\nSi preguntan algo completamente ajeno (chistes, tiempo, noticias, tareas, deportes, etc.):\n> \"Lo siento, pero no puedo ayudarle con eso. Mi funci√≥n es atender consultas sobre el Restaurante Esturi√≥n y gestionar reservas. ¬øPuedo ayudarle con algo relacionado con el restaurante?\"\n\n---\n\n# Horarios de apertura\n\n**CERRADO**: Lunes y Martes\n\n**ABIERTO**:\n- **Mi√©rcoles-S√°bado**: Desayunos 9:00-12:00h | Almuerzo 13:30-16:30h | Cena 21:00-23:30h\n- **Domingo**: Desayunos 9:00-12:00h | Almuerzo 13:30-16:30h | Cena 21:30-23:30h\n\n---\n\n# Capacidad del restaurante\n\n**Total**: 20 mesas, 80 comensales\n- 8 mesas de 2 personas\n- 6 mesas de 4 personas\n- 4 mesas de 6 personas\n- 2 mesas de 8 personas\n\n**Duraci√≥n servicios**:\n- Desayuno: 60 min\n- Almuerzo/Cena: 120 min\n\n**L√≥gica asignaci√≥n**: Asigna siempre la mesa m√°s peque√±a posible que acomode al grupo.\n\n---\n\n# Proceso de gesti√≥n de reservas con Google Calendar\n\n## Flujo completo:\n\n1. **Cliente solicita reserva** ‚Üí Identifica servicio (desayuno/almuerzo/cena)\n\n2. **Recopila info b√°sica**: d√≠a, hora aproximada, n√∫mero de personas\n\n3. **Valida horario de apertura**:\n   - ¬øEs mi√©rcoles-domingo? ‚Üí Contin√∫a\n   - ¬øEs lunes/martes? ‚Üí \"El restaurante est√° cerrado los lunes y martes. ¬øLe gustar√≠a reservar otro d√≠a?\"\n   - ¬øHora dentro del horario? ‚Üí Contin√∫a\n   - ¬øHora fuera del horario? ‚Üí \"En ese horario no estamos abiertos. [Indica horarios]. ¬øLe gustar√≠a reservar en alguno de estos horarios?\"\n\n4. **Consulta disponibilidad en Google Calendar**:\n   - Obt√©n todas las reservas del d√≠a\n   - Calcula mesas ocupadas por tipo\n   - Determina si hay mesa disponible para el grupo (aplicando l√≥gica de asignaci√≥n)\n\n5. **Responde seg√∫n disponibilidad**:\n   - **S√ç hay**: \"Tenemos disponibilidad para [n√∫mero] personas el [d√≠a] a las [hora]. ¬øDesea confirmar la reserva?\"\n   - **NO hay**: \"Ese horario est√° completo. ¬øLe gustar√≠a que le ofrezca otros horarios disponibles?\"\n\n6. **Espera confirmaci√≥n expl√≠cita** del cliente (\"S√≠, perfecto\", \"Vale\", \"Confirmado\")\n\n7. **Pide datos personales** (SOLO despu√©s de confirmaci√≥n):\n   - Nombre completo\n   - Tel√©fono de contacto\n   - N√∫mero de comensales (si no lo tienes)\n\n8. **Confirma todos los datos**: \"Confirmo: Reserva para [n√∫mero] personas el [d√≠a] [fecha] a las [hora] a nombre de [nombre], tel√©fono [tel√©fono]. ¬øEs correcto?\"\n\n9. **Crea reserva en Google Calendar**:\n   - T√≠tulo: \"[Nombre] - [n√∫mero] personas\"\n   - Inicio: [hora solicitada]\n   - Fin: [hora + duraci√≥n servicio]\n   - Descripci√≥n: Nombre, Tel√©fono, Comensales, Mesa asignada, Tipo de servicio\n\n10. **Confirma**: \"¬°Perfecto! Su reserva est√° confirmada para [n√∫mero] personas el [d√≠a] [fecha] a las [hora] üòä\"\n\n---\n\n## Modificar reserva (SOLO si cliente lo pide expresamente):\n\n1. Localiza reserva con nombre ‚Üí Usa herramienta \"Obtener Pr√≥ximas Reservas\"\n2. Confirma qu√© quiere modificar\n3. Valida horario de apertura y disponibilidad para nuevos datos\n4. Confirma cambios con cliente\n5. Ejecuta modificaci√≥n\n6. Confirma: \"Su reserva ha sido modificada. Ahora est√° confirmada para [nuevos datos] üòä\"\n\n---\n\n## Cancelar reserva (SOLO si cliente lo pide expresamente):\n\n1. Localiza reserva con nombre\n2. Confirma: \"¬øDesea cancelar su reserva para [datos]?\"\n3. Ejecuta cancelaci√≥n\n4. Confirma: \"Su reserva ha sido cancelada correctamente.\"\n5. NO ofrezcas autom√°ticamente reagendar (solo si cliente pregunta)\n\n---\n\n## Consultar reserva:\n\n1. Pide nombre completo\n2. Busca en Google Calendar\n3. Informa: \"Tengo su reserva para [datos]\" o \"No encuentro reserva a ese nombre. ¬øPodr√≠a estar a nombre de otra persona?\"\n\n---\n\n# Informaci√≥n del Restaurante Esturi√≥n\n\n**Datos b√°sicos**:\n- Direcci√≥n: Calle Bat√°n, s/n, 41100 Coria del R√≠o, Sevilla\n- Tel√©fono: +34 955 23 56 44\n- Cocina: Mediterr√°nea/Europea/Tradicional andaluza\n- Precio medio: 20-40‚Ç¨/persona\n- Parking: Privado gratuito\n- Accesibilidad: S√≠\n\n**Ambiente**: Junto al R√≠o Guadalquivir, interior acogedor y terraza con vistas. M√∫sica en directo en verano (jueves-s√°bado noche). Animaci√≥n infantil fines de semana.\n\n**Especialidades**: Pescados frescos (esturi√≥n), carnes a la brasa, arroces (negro, con pato), mariscos, vinos andaluces.\n\n**Platos destacados**: Esturi√≥n (varias preparaciones), arroz negro, carabineros, langostinos.\n\n**Eventos**: Bodas, celebraciones, eventos empresa. Para eventos grandes, recomienda llamar al +34 955 23 56 44.\n\n**Historia**: Antigua f√°brica de caviar de Coria del R√≠o (S.XX), fusiona patrimonio hist√≥rico con gastronom√≠a contempor√°nea.\n\n---\n\n# Reglas operativas\n\n## ‚úÖ SIEMPRE:\n- Consulta Google Calendar ANTES de ofrecer horarios\n- Valida d√≠a/hora en horario de apertura antes de consultar Calendar\n- Calcula disponibilidad de mesas correctamente\n- Confirma TODOS los datos antes de crear/modificar/cancelar\n- Pide datos personales SOLO despu√©s de confirmaci√≥n del cliente\n- Respeta fecha actual (`{{ $now }}`) para no ofrecer horas/d√≠as pasados\n- Pres√©ntate solo en primer mensaje\n- S√© natural y humana\n- Aplica l√≥gica de asignaci√≥n de mesas correctamente\n\n## ‚ùå NUNCA:\n- Ofrecer horarios sin consultar Google Calendar\n- Agendar fuera de horario de apertura\n- Asumir que cliente quiere reservar solo porque pregunta disponibilidad\n- Pedir datos personales antes de confirmaci√≥n\n- Ofrecer modificaciones/cancelaciones si cliente no lo pide\n- Repetir constantemente horarios sin que lo pidan\n- Mencionar que consultas Google Calendar o sistemas internos\n- Firmar mensajes con tu nombre\n- Usar caracteres raros o guiones decorativos\n- Preguntar \"¬øPuedo ayudarle en algo m√°s?\" al finalizar\n- Presentarte m√°s de una vez\n- Ofrecer servicios que no puedes cumplir (recordatorios, comida para llevar)\n\n---\n\n# Formato de salida JSON\n\n```json\n{\n  \"Response\": {\n    \"Part1\": \"Texto obligatorio\",\n    \"Part2\": \"Texto opcional si mensaje es largo (>800 chars)\",\n    \"Part3\": \"Texto opcional si mensaje es muy largo (>1200 chars)\"\n  }\n}\n```\n\n**Simula a un humano**: Divide mensajes largos en partes naturales. Cada parte debe terminar con frase completa.\n\n---\n\n# Fecha actual\n`{{ $now }}`\n\n√ösala para: no ofrecer horas/d√≠as pasados, calcular \"ma√±ana\"/\"este viernes\", validar reservas futuras.\n\n---\n\n# Objetivo\nServicio eficiente, c√°lido y profesional. El cliente debe sentir que habla con una recepcionista real que conoce perfectamente el restaurante y gestiona reservas con precisi√≥n absoluta."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        2400,
        64
      ],
      "id": "6d93d873-6291-4029-9e2c-496c07c313d5",
      "name": "AI Agent",
      "retryOnFail": false
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-5-mini",
          "mode": "list",
          "cachedResultName": "gpt-5-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        1968,
        288
      ],
      "id": "3b0338a4-1a50-4264-a2b0-2542f6f6b543",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "WvSLkCujVhY8jIGz",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.Identificador }}",
        "tableName": "=Cl√≠nica"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        2080,
        288
      ],
      "id": "1986cbbf-1b80-4765-b307-b7d893bbe5ae",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "lynsIk4t0FUvPeMz",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "3cf455fae61998f2cf7bfffba57a4e28188afc46dd5d892692826a9254905124@group.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Restaurante Esturi√≥n"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        2208,
        288
      ],
      "id": "f9aa0a07-2dae-4ac7-b6e5-668c36258668",
      "name": "Get many events in Google Calendar",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "BxLdTiBYRwntbItp",
          "name": "Google Calendar account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "c536a974-fb1f-4d5b-9970-5d59a0121721",
              "leftValue": "={{ $json.output.Response.Part1 }}",
              "rightValue": "false",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        3344,
        64
      ],
      "id": "e3b08d3d-b103-4476-aa8b-2bf1859c703a",
      "name": "If5"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://n8n2nkz-chatwoot.vc1wee.easypanel.host//api/v1/accounts/{{ $('Edit Fields').item.json.accountID }}/conversations/{{ $('Edit Fields').item.json.conversationID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": \"{{ $json.output.Response.Part1 }}\",\n  \"message_type\": \"outgoing\",\n  \"sender\": {\n    \"type\": \"bot\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3568,
        64
      ],
      "id": "4103dee4-d60f-42bb-99c4-57c3e7cf00dc",
      "name": "HTTP Request1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "s9IC0e9qhwPtXegM",
          "name": "Header Auth account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "7371417a-70c7-4cb2-936c-5a09884e761b",
              "leftValue": "={{ $('AI Agent').item.json.output.Response.Part2 }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        3792,
        64
      ],
      "id": "de3d7d65-16b5-41af-a204-4bd26ab0e861",
      "name": "If6"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        4016,
        64
      ],
      "id": "6924807d-eb02-49fc-8796-a4e74989f81f",
      "name": "Wait2",
      "webhookId": "751bef90-71de-41d2-ac4f-795b995cc5dd"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "79d91a9e-b4fa-47bd-a54a-6dcf817d24b5",
              "leftValue": "={{ $('AI Agent').item.json.output.Response.Part3 }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        4464,
        64
      ],
      "id": "b5ad238c-3058-4965-8b0f-9d479320bd0a",
      "name": "If7"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        4688,
        64
      ],
      "id": "6deea794-2afe-4c2e-8ec3-c0824a9e21b7",
      "name": "Wait3",
      "webhookId": "751bef90-71de-41d2-ac4f-795b995cc5dd"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "96158e05-c548-462c-94c3-8138dd2ceaf9",
              "leftValue": "={{ $json.message.last() }}",
              "rightValue": "={{ $('Edit Fields3').item.json.mensaje_audio }}",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1408,
        -32
      ],
      "id": "2494bb3a-eb40-4139-862e-30b6163f3c7d",
      "name": "If2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "d6581874-f941-437c-b4a6-90cb46415c1d",
              "leftValue": "={{ $json.tipo_mensaje }}",
              "rightValue": "audio",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -384,
        64
      ],
      "id": "24b6aa46-dc6e-4932-9661-2dbb4854ec08",
      "name": "If4"
    },
    {
      "parameters": {
        "description": "Usa esta herramienta cuando necesites m√°s razonamiento"
      },
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        2336,
        288
      ],
      "id": "cde0e889-80aa-4801-97fa-e3ebfe3ca6be",
      "name": "Think"
    },
    {
      "parameters": {
        "description": "=llama a esta herramienta cuando detectes la intencion del usuario de comprobar su disponibilidad o si quiere agendar un evento, reuni√≥n, llamada, etc.\nLa fecha actual es {{ $now }}",
        "workflowId": {
          "__rl": true,
          "value": "L6RP5mL1JuEWBAjS",
          "mode": "list",
          "cachedResultUrl": "/workflow/L6RP5mL1JuEWBAjS",
          "cachedResultName": "Disponibilidad Esturi√≥n"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "Fecha": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Fecha', ``, 'string') }}"
          },
          "matchingColumns": [
            "Fecha"
          ],
          "schema": [
            {
              "id": "Fecha",
              "displayName": "Fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        2464,
        288
      ],
      "id": "a8877125-d66f-43ed-b669-63cc77507419",
      "name": "Disponibilidad Esturion"
    },
    {
      "parameters": {
        "description": "=Llama a esta herramienta cuando detectes la intenci√≥n de el usuario de que quiere agendar un evento, cita, reuinion, llamada, etc, pero siempre una vez de haber comprobado la disponibilidad.\nLa fecha actual es {{ $now }}",
        "workflowId": {
          "__rl": true,
          "value": "usBIrNERTn5gZqI8",
          "mode": "list",
          "cachedResultUrl": "/workflow/usBIrNERTn5gZqI8",
          "cachedResultName": "Agendar Esturi√≥n"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "Titulo": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Titulo', ``, 'string') }}",
            "Descripci√≥n": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Descripci_n', ``, 'string') }}",
            "Fecha inicio": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Fecha_inicio', ``, 'string') }}",
            "Fecha fin": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Fecha_fin', ``, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Titulo",
              "displayName": "Titulo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Fecha inicio",
              "displayName": "Fecha inicio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Fecha fin",
              "displayName": "Fecha fin",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Descripci√≥n",
              "displayName": "Descripci√≥n",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        2592,
        288
      ],
      "id": "fe7832be-eeb8-4bb7-9eb5-5661b4a8e905",
      "name": "Agendar Esturion"
    },
    {
      "parameters": {
        "description": "=Llama a esta herramienta cuando detectes la intenci√≥n del usuario de modificar un evento, llamada, reuni√≥n, etc. Para modificar la fecha o la hora de un evento primero tienes que comprobar la nueva fecha o la nueva hora que quiere el usuario.\nLa fecha actual es {{ $now }}",
        "workflowId": {
          "__rl": true,
          "value": "r4N2wTKIasCoYE7U",
          "mode": "list",
          "cachedResultUrl": "/workflow/r4N2wTKIasCoYE7U",
          "cachedResultName": "Modificar Evento Esturion"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [
            {
              "id": "Titulo",
              "displayName": "Titulo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Fecha inicio",
              "displayName": "Fecha inicio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Fecha fin",
              "displayName": "Fecha fin",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Descripci√≥n",
              "displayName": "Descripci√≥n",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "ID",
              "displayName": "ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        2720,
        288
      ],
      "id": "c4cf055d-5be0-4cef-bd92-16a0bd2b270e",
      "name": "Modificar Evento Esturion"
    },
    {
      "parameters": {
        "description": "=Llama a esta herramienta cuando detectes la intenci√≥n del usuario de cancelar o eliminar un evento, llamada, reuni√≥n, etc.\nLa fecha actual es {{ $now }}",
        "workflowId": {
          "__rl": true,
          "value": "vRBdW8Ddciq6nwFA",
          "mode": "list",
          "cachedResultUrl": "/workflow/vRBdW8Ddciq6nwFA",
          "cachedResultName": "Cancelar Evento Esturion"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        2848,
        288
      ],
      "id": "aa6df1b0-9a97-4801-a212-b65125a236ba",
      "name": "Cancelar Evento Esturion"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://n8n2nkz-chatwoot.vc1wee.easypanel.host//api/v1/accounts/{{ $('Edit Fields').item.json.accountID }}/conversations/{{ $('Edit Fields').item.json.conversationID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": \"{{ $('AI Agent').item.json.output.Response.Part2 }}\",\n  \"message_type\": \"outgoing\",\n  \"sender\": {\n    \"type\": \"bot\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4240,
        64
      ],
      "id": "746ddb27-6fc8-4202-a6bd-36f3e0edc43f",
      "name": "HTTP Request2",
      "credentials": {
        "httpHeaderAuth": {
          "id": "Zhnapx6EMtJKOOW9",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://n8n2nkz-chatwoot.vc1wee.easypanel.host//api/v1/accounts/{{ $('Edit Fields').item.json.accountID }}/conversations/{{ $('Edit Fields').item.json.conversationID }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": \"{{ $('AI Agent').item.json.output.Response.Part3 }}\",\n  \"message_type\": \"outgoing\",\n  \"sender\": {\n    \"type\": \"bot\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4912,
        64
      ],
      "id": "67f2ac03-7aa4-43fa-99c9-a4e79e2b6095",
      "name": "HTTP Request3",
      "credentials": {
        "httpHeaderAuth": {
          "id": "Zhnapx6EMtJKOOW9",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"Response\": {\n    \"Part1\": \"Primera parte del mensaje\",\n    \"Part2\": \"Segunda parte del mensaje\",\n    \"Part3\": \"Tercera parte del mensaje\"\n  }\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        2976,
        288
      ],
      "id": "152eb64d-c906-4502-9173-88d4f4f22a4a",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-5-mini",
          "mode": "list",
          "cachedResultName": "gpt-5-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        2912,
        496
      ],
      "id": "e5276bae-11a4-4eb5-b606-4df65bb448bc",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "WvSLkCujVhY8jIGz",
          "name": "OpenAi account"
        }
      }
    }
  ],
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "n8n2nkz-n8n.vc1wee.easypanel.host",
            "user-agent": "rest-client/2.1.0 (linux-musl x86_64) ruby/3.3.3p89",
            "content-length": "4066",
            "accept": "application/json",
            "accept-encoding": "gzip;q=1.0,deflate;q=0.6,identity;q=0.3",
            "content-type": "application/json",
            "x-forwarded-for": "172.19.0.1",
            "x-forwarded-host": "n8n2nkz-n8n.vc1wee.easypanel.host",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "88eeb68a63a5",
            "x-real-ip": "172.19.0.1"
          },
          "params": {},
          "query": {},
          "body": {
            "account": {
              "id": 1,
              "name": "KZ"
            },
            "additional_attributes": {},
            "content_attributes": {},
            "content_type": "text",
            "content": "Ser√≠amos 5 personas",
            "conversation": {
              "additional_attributes": {},
              "can_reply": true,
              "channel": "Channel::Api",
              "contact_inbox": {
                "id": 106,
                "contact_id": 53,
                "inbox_id": 1,
                "source_id": "e1c078cc-ac43-4d40-84ff-b603601d5e1d",
                "created_at": "2026-02-03T19:11:12.900Z",
                "updated_at": "2026-02-03T19:11:12.900Z",
                "hmac_verified": false,
                "pubsub_token": "bj9aYyxPm7DsSJ3pPX1iDZNM"
              },
              "id": 53,
              "inbox_id": 1,
              "messages": [
                {
                  "id": 1419,
                  "content": "Ser√≠amos 5 personas",
                  "account_id": 1,
                  "inbox_id": 1,
                  "conversation_id": 53,
                  "message_type": 0,
                  "created_at": 1770216176,
                  "updated_at": "2026-02-04T14:42:56.950Z",
                  "private": false,
                  "status": "sent",
                  "source_id": "WAID:ACA636950ECAD661A0187A92937C7ECD",
                  "content_type": "text",
                  "content_attributes": {},
                  "sender_type": "Contact",
                  "sender_id": 53,
                  "external_source_ids": {},
                  "additional_attributes": {},
                  "processed_message_content": "Ser√≠amos 5 personas",
                  "sentiment": {},
                  "conversation": {
                    "assignee_id": null,
                    "unread_count": 1,
                    "last_activity_at": 1770216176,
                    "contact_inbox": {
                      "source_id": "e1c078cc-ac43-4d40-84ff-b603601d5e1d"
                    }
                  },
                  "sender": {
                    "additional_attributes": {},
                    "custom_attributes": {},
                    "email": null,
                    "id": 53,
                    "identifier": "107743633522761@lid",
                    "name": "Andr√©s Sierra",
                    "phone_number": "+34608450569",
                    "thumbnail": "http://https/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBY1k9IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--7eccb59e61c91ed7a903a3e1d7de92588e1e68e7/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCem9MWm05eWJXRjBTU0lJYW5CbkJqb0dSVlE2RTNKbGMybDZaVjkwYjE5bWFXeHNXd2RwQWZvdyIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--3ee3a98e3eb1528ac39b3dd1284c2b0d768e8e96/292481748_744052253585453_5866720819892846216_n.jpg",
                    "type": "contact"
                  }
                }
              ],
              "labels": [],
              "meta": {
                "sender": {
                  "additional_attributes": {},
                  "custom_attributes": {},
                  "email": null,
                  "id": 53,
                  "identifier": "107743633522761@lid",
                  "name": "Andr√©s Sierra",
                  "phone_number": "+34608450569",
                  "thumbnail": "http://https/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBY1k9IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--7eccb59e61c91ed7a903a3e1d7de92588e1e68e7/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCem9MWm05eWJXRjBTU0lJYW5CbkJqb0dSVlE2RTNKbGMybDZaVjkwYjE5bWFXeHNXd2RwQWZvdyIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--3ee3a98e3eb1528ac39b3dd1284c2b0d768e8e96/292481748_744052253585453_5866720819892846216_n.jpg",
                  "type": "contact"
                },
                "assignee": null,
                "team": null,
                "hmac_verified": false
              },
              "status": "open",
              "custom_attributes": {},
              "snoozed_until": null,
              "unread_count": 1,
              "first_reply_created_at": "2026-02-03T19:11:13.478Z",
              "priority": null,
              "waiting_since": 1770216176,
              "agent_last_seen_at": 1770216170,
              "contact_last_seen_at": 1770216157,
              "last_activity_at": 1770216176,
              "timestamp": 1770216176,
              "created_at": 1770145872
            },
            "created_at": "2026-02-04T14:42:56.950Z",
            "id": 1419,
            "inbox": {
              "id": 1,
              "name": "Practica UDIA"
            },
            "message_type": "incoming",
            "private": false,
            "sender": {
              "account": {
                "id": 1,
                "name": "KZ"
              },
              "additional_attributes": {},
              "avatar": "http://https/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBY1k9IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--7eccb59e61c91ed7a903a3e1d7de92588e1e68e7/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCem9MWm05eWJXRjBTU0lJYW5CbkJqb0dSVlE2RTNKbGMybDZaVjkwYjE5bWFXeHNXd2RwQWZvdyIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--3ee3a98e3eb1528ac39b3dd1284c2b0d768e8e96/292481748_744052253585453_5866720819892846216_n.jpg",
              "custom_attributes": {},
              "email": null,
              "id": 53,
              "identifier": "107743633522761@lid",
              "name": "Andr√©s Sierra",
              "phone_number": "+34608450569",
              "thumbnail": "http://https/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBY1k9IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--7eccb59e61c91ed7a903a3e1d7de92588e1e68e7/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCem9MWm05eWJXRjBTU0lJYW5CbkJqb0dSVlE2RTNKbGMybDZaVjkwYjE5bWFXeHNXd2RwQWZvdyIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--3ee3a98e3eb1528ac39b3dd1284c2b0d768e8e96/292481748_744052253585453_5866720819892846216_n.jpg"
            },
            "source_id": "WAID:ACA636950ECAD661A0187A92937C7ECD",
            "event": "message_created"
          },
          "webhookUrl": "https://n8n2nkz-n8n.vc1wee.easypanel.host/webhook/cf611be9-ebe6-48f4-af1c-6996d5dfb497",
          "executionMode": "production"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "timezone": "Europe/Madrid",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "shared": [
    {
      "updatedAt": "2026-01-23T15:22:44.687Z",
      "createdAt": "2026-01-23T15:22:44.687Z",
      "role": "workflow:owner",
      "workflowId": "-cgq3cFKFQQwwszD4Iorv",
      "projectId": "Mg9CftDHMIrQGniA"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2026-02-04T14:52:38.358Z",
  "versionId": "d0fde208-f813-40b4-8797-86729718f106"
}